# å±¥çº¦é©±åŠ¨é…’åº—ç®¡ç†ç³»ç»Ÿ - æ··åˆéƒ¨ç½²
# å‰ç«¯éƒ¨ç½²åˆ°GitHub Pagesï¼Œåç«¯éƒ¨ç½²åˆ°å…è´¹äº‘å¹³å°

name: Hybrid Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # éƒ¨ç½²å‰ç«¯åˆ°GitHub Pages
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: æ„å»ºå‰ç«¯
        run: npm run build
        env:
          VITE_API_BASE_URL: https://fulfillment-backend.railway.app
          
      - name: éƒ¨ç½²åˆ°GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: hotel.archpeng.dev  # å¯é€‰ï¼šè‡ªå®šä¹‰åŸŸå

  # è§¦å‘åç«¯éƒ¨ç½²ï¼ˆé€šè¿‡Railwayï¼‰
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è§¦å‘Railwayéƒ¨ç½²
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://backboard.railway.app/graphql/v2 \
            -d '{"query":"mutation { deploymentCreate(input: { projectId: \"${{ secrets.RAILWAY_PROJECT_ID }}\", environmentId: \"${{ secrets.RAILWAY_ENV_ID }}\" }) { id } }"}'

  # å¥åº·æ£€æŸ¥
  health-check:
    needs: [deploy-frontend, deploy-backend]
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥å‰ç«¯éƒ¨ç½²
        run: |
          sleep 60  # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          curl -f https://archpeng.github.io/fulfillment-driven-hotel-management/ || exit 1
          
      - name: æ£€æŸ¥åç«¯éƒ¨ç½²
        run: |
          curl -f https://fulfillment-backend.railway.app/health || exit 1
          
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ å±¥çº¦é©±åŠ¨é…’åº—ç®¡ç†ç³»ç»Ÿéƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: https://archpeng.github.io/fulfillment-driven-hotel-management/"
          echo "ğŸ”§ åç«¯åœ°å€: https://fulfillment-backend.railway.app"