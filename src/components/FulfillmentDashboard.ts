/**
 * å±¥çº¦é©±åŠ¨ç®¡ç†ä»ªè¡¨æ¿
 * "æˆ‘ä»¬ä¸ç®¡ç†å®¢æˆ¿ï¼Œæˆ‘ä»¬ç®¡ç†å®¢äºº"
 */

import { rxdbManager } from '../database/RxDBManager';
import { RxDBSyncManager } from '../database/RxDBSyncManager';

export class FulfillmentDashboard {
  private container: HTMLElement;
  private syncManager?: RxDBSyncManager;
  private updateInterval?: number;

  constructor(containerId: string) {
    const container = document.getElementById(containerId);
    if (!container) {
      throw new Error(`Container ${containerId} not found`);
    }
    this.container = container;
  }

  /**
   * åˆå§‹åŒ–ä»ªè¡¨æ¿
   */
  public async initialize(): Promise<void> {
    console.log('ğŸ¨ åˆå§‹åŒ–å±¥çº¦é©±åŠ¨ç®¡ç†ä»ªè¡¨æ¿...');

    try {
      // åˆå§‹åŒ–æ•°æ®åº“
      await rxdbManager.initialize();
      
      // åˆ›å»ºæ¼”ç¤ºæ•°æ®
      await rxdbManager.createDemoData();

      // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨
      this.syncManager = new RxDBSyncManager(rxdbManager.getDatabase(), {
        backendUrl: 'https://fulfillment-driven-hotel-management-production.up.railway.app',
        collections: ['guests']
      });

      // æ¸²æŸ“ç•Œé¢
      await this.render();

      // è®¾ç½®å®šæ—¶æ›´æ–°
      this.startAutoUpdate();

      console.log('âœ… å±¥çº¦é©±åŠ¨ç®¡ç†ä»ªè¡¨æ¿åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('âŒ ä»ªè¡¨æ¿åˆå§‹åŒ–å¤±è´¥:', error);
      this.renderError(error);
    }
  }

  /**
   * æ¸²æŸ“ä¸»ç•Œé¢
   */
  private async render(): Promise<void> {
    const stats = await rxdbManager.getStats();
    const guestsCollection = rxdbManager.getGuestsCollection();
    
    // è·å–æœ€æ–°çš„å®¢äººæ•°æ®
    const recentGuests = await guestsCollection
      .find({
        sort: [{ createdAt: 'desc' }],
        limit: 5
      })
      .exec();

    this.container.innerHTML = `
      <div class="fulfillment-dashboard">
        <!-- ä»ªè¡¨æ¿å¤´éƒ¨ -->
        <header class="dashboard-header">
          <div class="header-content">
            <div class="logo">
              <span class="logo-icon">ğŸ¨</span>
              <div class="logo-text">
                <h1>å±¥çº¦é©±åŠ¨ç®¡ç†ç³»ç»Ÿ</h1>
                <p>"æˆ‘ä»¬ä¸ç®¡ç†å®¢æˆ¿ï¼Œæˆ‘ä»¬ç®¡ç†å®¢äºº"</p>
              </div>
            </div>
            
            <div class="sync-status" id="sync-status">
              <div class="sync-indicator loading">
                <span class="sync-icon">ğŸ”„</span>
                <span class="sync-text">æ£€æŸ¥åŒæ­¥çŠ¶æ€...</span>
              </div>
            </div>
          </div>
        </header>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <section class="stats-overview">
          <div class="stats-grid">
            <div class="stat-card primary">
              <div class="stat-icon">ğŸ‘¥</div>
              <div class="stat-content">
                <div class="stat-number">${stats.total}</div>
                <div class="stat-label">æ€»å®¢äººæ•°</div>
              </div>
            </div>
            
            ${this.renderStageStats(stats.byStage)}
          </div>
        </section>

        <!-- å±¥çº¦é˜¶æ®µæµç¨‹å›¾ -->
        <section class="fulfillment-flow">
          <h2>äº”é˜¶æ®µå±¥çº¦æµç¨‹</h2>
          <div class="flow-diagram">
            ${this.renderFlowDiagram(stats.byStage)}
          </div>
        </section>

        <!-- å®¢äººç®¡ç†åŒºåŸŸ -->
        <section class="guest-management">
          <div class="management-header">
            <h2>å®¢äººå±¥çº¦ç®¡ç†</h2>
            <div class="management-actions">
              <button class="btn-primary" onclick="fulfillmentDashboard.addNewGuest()">
                <span>â•</span> æ–°å¢å®¢äºº
              </button>
              <button class="btn-secondary" onclick="fulfillmentDashboard.syncData()">
                <span>ğŸ”„</span> åŒæ­¥æ•°æ®
              </button>
            </div>
          </div>

          <!-- ç­›é€‰å™¨ -->
          <div class="filters">
            <select id="stage-filter" onchange="fulfillmentDashboard.filterByStage(this.value)">
              <option value="">æ‰€æœ‰é˜¶æ®µ</option>
              <option value="awareness">è®¤çŸ¥é˜¶æ®µ</option>
              <option value="evaluation">è¯„ä¼°é˜¶æ®µ</option>
              <option value="booking">é¢„è®¢é˜¶æ®µ</option>
              <option value="experiencing">ä½“éªŒé˜¶æ®µ</option>
              <option value="feedback">åé¦ˆé˜¶æ®µ</option>
            </select>
            
            <select id="loyalty-filter" onchange="fulfillmentDashboard.filterByLoyalty(this.value)">
              <option value="">æ‰€æœ‰ç­‰çº§</option>
              <option value="bronze">é“œç‰Œ</option>
              <option value="silver">é“¶ç‰Œ</option>
              <option value="gold">é‡‘ç‰Œ</option>
              <option value="platinum">ç™½é‡‘</option>
            </select>
          </div>

          <!-- å®¢äººåˆ—è¡¨ -->
          <div class="guests-list" id="guests-list">
            ${this.renderGuestsList(recentGuests)}
          </div>
        </section>

        <!-- å®æ—¶æ•°æ®åŒæ­¥æµ‹è¯• -->
        <section class="sync-testing">
          <h2>å®æ—¶æ•°æ®åŒæ­¥æµ‹è¯•</h2>
          <div class="sync-test-controls">
            <button class="btn-test" onclick="fulfillmentDashboard.testOfflineSync()">
              ğŸ“± æµ‹è¯•ç¦»çº¿æ¨¡å¼
            </button>
            <button class="btn-test" onclick="fulfillmentDashboard.testConflictResolution()">
              âš–ï¸ æµ‹è¯•å†²çªè§£å†³
            </button>
            <button class="btn-test" onclick="fulfillmentDashboard.simulateMultiDevice()">
              ğŸ’» æ¨¡æ‹Ÿå¤šè®¾å¤‡åŒæ­¥
            </button>
          </div>
          <div class="sync-log" id="sync-log">
            <div class="log-item">
              <span class="log-time">${new Date().toLocaleTimeString()}</span>
              <span class="log-message">ğŸ“Š ä»ªè¡¨æ¿åŠ è½½å®Œæˆï¼Œå…± ${stats.total} ä½å®¢äºº</span>
            </div>
          </div>
        </section>
      </div>
    `;

    // åˆå§‹åŒ–åŒæ­¥çŠ¶æ€
    await this.updateSyncStatus();
  }

  /**
   * æ¸²æŸ“é˜¶æ®µç»Ÿè®¡
   */
  private renderStageStats(stageStats: any[]): string {
    const stageNames = {
      awareness: 'è®¤çŸ¥',
      evaluation: 'è¯„ä¼°', 
      booking: 'é¢„è®¢',
      experiencing: 'ä½“éªŒ',
      feedback: 'åé¦ˆ'
    };

    const stageIcons = {
      awareness: 'ğŸ‘ï¸',
      evaluation: 'ğŸ¤”',
      booking: 'ğŸ“…',
      experiencing: 'ğŸ¨',
      feedback: 'ğŸ’¬'
    };

    return stageStats.map(({ stage, count }) => `
      <div class="stat-card ${stage}">
        <div class="stat-icon">${stageIcons[stage] || 'ğŸ“Š'}</div>
        <div class="stat-content">
          <div class="stat-number">${count}</div>
          <div class="stat-label">${stageNames[stage] || stage}</div>
        </div>
      </div>
    `).join('');
  }

  /**
   * æ¸²æŸ“æµç¨‹å›¾
   */
  private renderFlowDiagram(stageStats: any[]): string {
    const stages = [
      { key: 'awareness', name: 'è®¤çŸ¥é˜¶æ®µ', icon: 'ğŸ‘ï¸', color: '#3b82f6' },
      { key: 'evaluation', name: 'è¯„ä¼°é˜¶æ®µ', icon: 'ğŸ¤”', color: '#8b5cf6' },
      { key: 'booking', name: 'é¢„è®¢é˜¶æ®µ', icon: 'ğŸ“…', color: '#10b981' },
      { key: 'experiencing', name: 'ä½“éªŒé˜¶æ®µ', icon: 'ğŸ¨', color: '#f59e0b' },
      { key: 'feedback', name: 'åé¦ˆé˜¶æ®µ', icon: 'ğŸ’¬', color: '#ef4444' }
    ];

    return stages.map((stage, index) => {
      const stat = stageStats.find(s => s.stage === stage.key);
      const count = stat ? stat.count : 0;
      const isLast = index === stages.length - 1;

      return `
        <div class="flow-stage" style="border-color: ${stage.color}">
          <div class="stage-header" style="background-color: ${stage.color}">
            <span class="stage-icon">${stage.icon}</span>
            <span class="stage-name">${stage.name}</span>
          </div>
          <div class="stage-count">${count} ä½å®¢äºº</div>
          <div class="stage-progress">
            <div class="progress-bar" style="width: ${count * 20}%; background-color: ${stage.color}"></div>
          </div>
        </div>
        ${!isLast ? '<div class="flow-arrow">â†’</div>' : ''}
      `;
    }).join('');
  }

  /**
   * æ¸²æŸ“å®¢äººåˆ—è¡¨
   */
  private renderGuestsList(guests: any[]): string {
    if (guests.length === 0) {
      return `
        <div class="empty-state">
          <div class="empty-icon">ğŸ‘¥</div>
          <div class="empty-message">æš‚æ— å®¢äººæ•°æ®</div>
          <button class="btn-primary" onclick="fulfillmentDashboard.createDemoData()">
            åˆ›å»ºæ¼”ç¤ºæ•°æ®
          </button>
        </div>
      `;
    }

    return `
      <div class="guests-table">
        <div class="table-header">
          <div class="col-name">å®¢äººå§“å</div>
          <div class="col-phone">è”ç³»ç”µè¯</div>
          <div class="col-stage">å±¥çº¦é˜¶æ®µ</div>
          <div class="col-loyalty">å¿ è¯šåº¦</div>
          <div class="col-value">ç”Ÿå‘½ä»·å€¼</div>
          <div class="col-actions">æ“ä½œ</div>
        </div>
        ${guests.map(guest => this.renderGuestRow(guest)).join('')}
      </div>
    `;
  }

  /**
   * æ¸²æŸ“å®¢äººè¡Œ
   */
  private renderGuestRow(guest: any): string {
    const stageNames = {
      awareness: 'è®¤çŸ¥',
      evaluation: 'è¯„ä¼°',
      booking: 'é¢„è®¢', 
      experiencing: 'ä½“éªŒ',
      feedback: 'åé¦ˆ'
    };

    const loyaltyNames = {
      bronze: 'é“œç‰Œ',
      silver: 'é“¶ç‰Œ',
      gold: 'é‡‘ç‰Œ',
      platinum: 'ç™½é‡‘'
    };

    const loyaltyColors = {
      bronze: '#cd7f32',
      silver: '#c0c0c0', 
      gold: '#ffd700',
      platinum: '#e5e4e2'
    };

    return `
      <div class="table-row" onclick="fulfillmentDashboard.viewGuest('${guest.id}')">
        <div class="col-name">
          <div class="guest-name">${guest.personalInfo.name}</div>
          <div class="guest-id">${guest.id}</div>
        </div>
        <div class="col-phone">${guest.personalInfo.phone}</div>
        <div class="col-stage">
          <span class="stage-badge ${guest.fulfillmentHistory.currentStage}">
            ${stageNames[guest.fulfillmentHistory.currentStage] || guest.fulfillmentHistory.currentStage}
          </span>
        </div>
        <div class="col-loyalty">
          <span class="loyalty-badge" style="background-color: ${loyaltyColors[guest.tags.loyaltyLevel]}">
            ${loyaltyNames[guest.tags.loyaltyLevel] || guest.tags.loyaltyLevel}
          </span>
        </div>
        <div class="col-value">Â¥${guest.businessMetrics.lifetimeValue.toFixed(2)}</div>
        <div class="col-actions">
          <button class="btn-small" onclick="event.stopPropagation(); fulfillmentDashboard.advanceStage('${guest.id}')">
            è¿›å…¥ä¸‹é˜¶æ®µ
          </button>
        </div>
      </div>
    `;
  }

  /**
   * æ›´æ–°åŒæ­¥çŠ¶æ€
   */
  private async updateSyncStatus(): Promise<void> {
    const statusElement = document.getElementById('sync-status');
    if (!statusElement || !this.syncManager) return;

    try {
      const health = await this.syncManager.checkSyncHealth();
      
      statusElement.innerHTML = `
        <div class="sync-indicator ${health.healthy ? 'healthy' : 'error'}">
          <span class="sync-icon">${health.healthy ? 'âœ…' : 'âŒ'}</span>
          <span class="sync-text">${health.message}</span>
        </div>
      `;
    } catch (error) {
      statusElement.innerHTML = `
        <div class="sync-indicator error">
          <span class="sync-icon">âŒ</span>
          <span class="sync-text">åŒæ­¥æœåŠ¡ä¸å¯ç”¨</span>
        </div>
      `;
    }
  }

  /**
   * å¼€å§‹è‡ªåŠ¨æ›´æ–°
   */
  private startAutoUpdate(): void {
    this.updateInterval = window.setInterval(async () => {
      await this.updateSyncStatus();
      // å¯ä»¥æ·»åŠ æ›´å¤šè‡ªåŠ¨æ›´æ–°é€»è¾‘
    }, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
  }

  /**
   * åœæ­¢è‡ªåŠ¨æ›´æ–°
   */
  public stopAutoUpdate(): void {
    if (this.updateInterval) {
      clearInterval(this.updateInterval);
      this.updateInterval = undefined;
    }
  }

  /**
   * æ¸²æŸ“é”™è¯¯ç•Œé¢
   */
  private renderError(error: any): void {
    this.container.innerHTML = `
      <div class="error-container">
        <div class="error-icon">âš ï¸</div>
        <div class="error-title">åˆå§‹åŒ–å¤±è´¥</div>
        <div class="error-message">${error.message}</div>
        <button class="btn-primary" onclick="location.reload()">
          é‡æ–°åŠ è½½
        </button>
      </div>
    `;
  }

  /**
   * å…¬å…±æ–¹æ³• - æ·»åŠ æ–°å®¢äºº
   */
  public async addNewGuest(): Promise<void> {
    const name = prompt('è¯·è¾“å…¥å®¢äººå§“å:');
    const phone = prompt('è¯·è¾“å…¥è”ç³»ç”µè¯:');
    
    if (!name || !phone) return;

    try {
      const guestsCollection = rxdbManager.getGuestsCollection();
      const newGuest = {
        id: `guest-${Date.now()}`,
        personalInfo: {
          name,
          phone,
          email: '',
          idCard: '',
          address: ''
        },
        fulfillmentHistory: {
          currentStage: 'awareness',
          stageStartTime: new Date(),
          completedStages: [],
          journeyCount: 1
        },
        businessMetrics: {
          lifetimeValue: 0,
          totalBookings: 0,
          averageRating: 0,
          referralCount: 0
        },
        tags: {
          loyaltyLevel: 'bronze',
          riskLevel: 'low',
          valueSegment: 'standard'
        },
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        createdBy: 'user',
        version: 1,
        isDeleted: false
      };

      await guestsCollection.insert(newGuest);
      this.addLogMessage(`âœ… æ–°å¢å®¢äºº: ${name} (${phone})`);
      await this.render(); // åˆ·æ–°ç•Œé¢
    } catch (error) {
      console.error('æ·»åŠ å®¢äººå¤±è´¥:', error);
      this.addLogMessage(`âŒ æ·»åŠ å®¢äººå¤±è´¥: ${error.message}`);
    }
  }

  /**
   * åŒæ­¥æ•°æ®
   */
  public async syncData(): Promise<void> {
    if (!this.syncManager) return;

    try {
      this.addLogMessage('ğŸ”„ å¼€å§‹æ•°æ®åŒæ­¥...');
      await this.syncManager.startAllSync();
      this.addLogMessage('âœ… æ•°æ®åŒæ­¥å·²å¯åŠ¨');
    } catch (error) {
      this.addLogMessage(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * æ·»åŠ æ—¥å¿—æ¶ˆæ¯
   */
  private addLogMessage(message: string): void {
    const logElement = document.getElementById('sync-log');
    if (!logElement) return;

    const logItem = document.createElement('div');
    logItem.className = 'log-item';
    logItem.innerHTML = `
      <span class="log-time">${new Date().toLocaleTimeString()}</span>
      <span class="log-message">${message}</span>
    `;

    logElement.insertBefore(logItem, logElement.firstChild);

    // ä¿æŒæœ€å¤š10æ¡æ—¥å¿—
    const logItems = logElement.querySelectorAll('.log-item');
    if (logItems.length > 10) {
      logItems[logItems.length - 1].remove();
    }
  }

  /**
   * æ¸…ç†èµ„æº
   */
  public cleanup(): void {
    this.stopAutoUpdate();
  }
}

// å…¨å±€å®ä¾‹
declare global {
  interface Window {
    fulfillmentDashboard: FulfillmentDashboard;
  }
}